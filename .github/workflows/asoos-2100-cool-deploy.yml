name: ğŸš€ ASOOS.2100.Cool CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'public/index.html'
      - 'public/asoos-2100-cool/**'
      - '.github/workflows/asoos-2100-cool-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'public/index.html'
      - 'public/asoos-2100-cool/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_deploy:
        description: 'Force deployment (bypass checks)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: api-for-warp-drive
  REGION: us-west1
  FIREBASE_SITE: asoos-2100-cool
  TARGET_NAME: 2100-cool-c624d

jobs:
  validate:
    name: ğŸ” Validate HTML & Configuration
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./integration-gateway
        run: npm ci

      - name: âœ… Validate HTML syntax
        run: |
          echo "ğŸ” Validating HTML file syntax..."
          python3 -c "
          import html
          import sys
          
          try:
              with open('./integration-gateway/public/index.html', 'r') as f:
                  content = f.read()
              
              # Check for HTML entities that need to be decoded
              if '&lt;' in content or '&gt;' in content:
                  print('âŒ HTML entities found - need to decode')
                  sys.exit(1)
              
              # Basic HTML validation
              if not content.strip().startswith('<!DOCTYPE html>'):
                  print('âŒ Missing DOCTYPE declaration')
                  sys.exit(1)
              
              if '<html' not in content or '</html>' not in content:
                  print('âŒ Missing HTML tags')
                  sys.exit(1)
              
              print('âœ… HTML syntax validation passed')
              
          except Exception as e:
              print(f'âŒ Validation failed: {e}')
              sys.exit(1)
          "

      - name: ğŸ¯ Validate Firebase configuration
        run: |
          echo "ğŸ” Validating Firebase configuration..."
          if ! grep -q "2100-cool-c624d" ./integration-gateway/firebase.json; then
            echo "âŒ Target 2100-cool-c624d not found in firebase.json"
            exit 1
          fi
          echo "âœ… Firebase configuration valid"

  sync-content:
    name: ğŸ”„ Sync Content to Target Directory
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”„ Sync main index.html to asoos-2100-cool directory
        run: |
          echo "ğŸ”„ Syncing content..."
          mkdir -p ./integration-gateway/public/asoos-2100-cool
          cp ./integration-gateway/public/index.html ./integration-gateway/public/asoos-2100-cool/index.html
          echo "âœ… Content synced successfully"

      - name: ğŸ“¦ Upload synced content as artifact
        uses: actions/upload-artifact@v4
        with:
          name: asoos-2100-cool-content
          path: ./integration-gateway/public/asoos-2100-cool/
          retention-days: 7

  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, sync-content]
    if: github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    environment: staging
    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download synced content
        uses: actions/download-artifact@v4
        with:
          name: asoos-2100-cool-content
          path: ./integration-gateway/public/asoos-2100-cool/

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ“¦ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸ§ª Deploy to Firebase Staging
        working-directory: ./integration-gateway
        run: |
          echo "ğŸ§ª Deploying to staging environment..."
          firebase use $PROJECT_ID
          firebase target:apply hosting $TARGET_NAME $FIREBASE_SITE
          firebase deploy --only hosting:$TARGET_NAME --message "Staging deployment for asoos.2100.cool"

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, sync-content]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download synced content
        uses: actions/download-artifact@v4
        with:
          name: asoos-2100-cool-content
          path: ./integration-gateway/public/asoos-2100-cool/

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ“¦ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸ¯ Set Firebase targets
        working-directory: ./integration-gateway
        run: |
          firebase use $PROJECT_ID
          firebase target:apply hosting $TARGET_NAME $FIREBASE_SITE

      - name: ğŸš€ Deploy to Firebase Production
        working-directory: ./integration-gateway
        run: |
          echo "ğŸš€ Deploying to production environment..."
          firebase deploy --only hosting:$TARGET_NAME --message "Production deployment for asoos.2100.cool - $(date)"

      - name: âœ… Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 30
          if curl -f -s https://asoos-2100-cool.web.app/ > /dev/null; then
            echo "âœ… Deployment verification successful"
          else
            echo "âŒ Deployment verification failed"
            exit 1
          fi

  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "ğŸ‰ ASOOS.2100.Cool production deployment successful!"
            echo "ğŸŒ Live at: https://asoos.2100.cool"
          elif [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "ğŸ§ª ASOOS.2100.Cool staging deployment successful!"
          else
            echo "âŒ Deployment failed - check logs"
          fi

  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: ğŸ§¹ Clean up artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name === 'asoos-2100-cool-content') {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`Deleted artifact: ${artifact.name}`);
              }
            }
