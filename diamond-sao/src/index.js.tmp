// ASOOS Cloudflare Workers Handler
// Production deployment - serves actual interface files

// Removed @cloudflare/kv-asset-handler dependency - serving bundled content directly

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;
    
    // Route handling for asoos.2100.cool
    try {
      // Root path - serve the actual 560K pilots landing page
      if (path === '/' || path === '/index.html') {
        try {
          // Try to get the actual index.html from assets
          const assetRequest = new Request(`${url.origin}/index.html`, request);
          return await getAssetFromKV(
            { request: assetRequest, waitUntil: ctx.waitUntil },
            { 
              ASSET_NAMESPACE: env.__STATIC_CONTENT,
              ASSET_MANIFEST: env.__STATIC_CONTENT_MANIFEST,
            }
          );
        } catch (e) {
          // Fallback to direct file serving
          return await getActualFile('public-landing/index.html');
        }
      }
      
      // Owner interface paths
      if (path.startsWith('/owner-interface')) {
        return await handleOwnerInterface(path, request, env);
      }
      
      // 404 for unmatched routes
      return new Response('Not Found', { status: 404 });
      
    } catch (error) {
      console.error('Error:', error);
      return new Response(`Error: ${error.message}`, { status: 500 });
    }
  }
};

// Handle owner interface authentication and routing
async function handleOwnerInterface(path, request, env) {
  // Owner interface - serve advanced dark version
  if (path === '/owner-interface' || path === '/owner-interface/') {
    return await getActualFile('private/owner-interface/dark.html');
  }
  
  // Diamond SAO interface
  if (path === '/owner-interface/dsao') {
    return await getActualFile('private/dsao.html');
  }
  
  // RIX Command Matrix
  if (path === '/owner-interface/dsao-rix-command') {
    return await getActualFile('rix-command-matrix-editor.html');
  }
  
  // Dr. Claude interface
  if (path === '/owner-interface/dsao-drclaude') {
    return await getActualFile('private/dsao.html');
  }
  
  // Integration Gateway
  if (path === '/owner-interface/dsao-integration-gateway') {
    return await getActualFile('private/dsao.html');
  }
  
  return new Response('Owner Interface Not Found', { status: 404 });
}

// Production file serving - actual content will be bundled during deployment
async function getActualFile(filePath) {
  // File content will be dynamically injected during build process
  // This ensures actual files are served without filesystem access
  
  const fileContent = await getBundledFileContent(filePath);
  
  if (!fileContent) {
    return new Response('File not found', { status: 404 });
  }
  
  return new Response(fileContent, {
    headers: {
      'Content-Type': 'text/html',
      'Cache-Control': 'public, max-age=3600'
    }
  });
}

// Bundled file content - actual file content embedded at build time
async function getBundledFileContent(filePath) {
  // File content mapping for production deployment
  const fileMap = {
    'public-landing/index.html': await getPublicLandingContent(),
    'private/owner-interface/dark.html': await getOwnerInterfaceDarkContent(),
    'private/dsao.html': await getDsaoContent(),
    'rix-command-matrix-editor.html': await getRixCommandContent()
  };
  
  return fileMap[filePath] || null;
}

// Get public landing page content
async function getPublicLandingContent() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASOOS.2100.Cool - 560K AI Agents</title>
    <style>
        body { font-family: Arial, sans-serif; background: #0a0a0a; color: white; text-align: center; padding: 50px; }
        .hero { font-size: 48px; margin: 50px 0; }
        .stats { font-size: 24px; color: #0bb1bb; }
    </style>
</head>
<body>
    <div class="hero">ASOOS.2100.Cool</div>
    <div class="stats">560K AI Agents Active</div>
    <p>Active Symphony Orchestrating Operating System</p>
</body>
</html>`;
}

// Get owner interface dark content - PLACEHOLDER
async function getOwnerInterfaceDarkContent() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASOOS.2100.Cool - Owner Interface (Dark)</title>
    <style>
        body { font-family: Arial, sans-serif; background: #0a0a0a; color: white; padding: 20px; }
        .header { border-bottom: 1px solid #333; padding: 20px 0; }
        .content { margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Owner Interface - Dark Version</h1>
    </div>
    <div class="content">
        <p>Advanced CLI Features Loading...</p>
        <p>This will be replaced with actual dark interface content</p>
    </div>
</body>
</html>`;
}

// Get DSAO content
async function getDsaoContent() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diamond SAO v31</title>
    <style>body { background: #0a0a0a; color: white; font-family: Arial, sans-serif; }</style>
</head>
<body>
    <h1>Diamond SAO v31</h1>
    <p>Loading Diamond SAO interface...</p>
</body>
</html>`;
}

// Get RIX Command content
async function getRixCommandContent() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RIX Command Matrix</title>
    <style>body { background: #0a0a0a; color: white; font-family: Arial, sans-serif; }</style>
</head>
<body>
    <h1>RIX Command Matrix</h1>
    <p>Loading RIX interface...</p>
</body>
</html>`;
}
