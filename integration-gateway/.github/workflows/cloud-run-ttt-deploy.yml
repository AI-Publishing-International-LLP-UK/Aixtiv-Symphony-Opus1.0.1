name: Cloud Run TTT Deployment Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip test stages'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write
  pull-requests: write
  checks: write

env:
  PROJECT_ID: api-for-warp-drive
  REGION: us-west1
  ZONE: us-west1-b
  REGISTRY: us-west1-docker.pkg.dev/api-for-warp-drive/integration-gateway
  SERVICE_NAME: integration-gateway
  
jobs:
  # Test Phase 1 - Pre-build Testing
  test-pre-build:
    name: "T1: Pre-build Tests"
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.skip_tests }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linting
        run: |
          if [ -f ".eslintrc.js" ]; then
            npm run lint || true  # Don't fail on linting errors in CI
          fi
          
      - name: Run unit tests
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test || echo "Tests not configured or failed"
          fi
          
      - name: Security scan
        run: |
          npm audit --audit-level=high || echo "Security audit completed with warnings"
          
      - name: Validate Dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            docker build --dry-run . || echo "Dockerfile validation completed"
          fi

  # Build and Deploy Phase
  build-and-deploy:
    name: "Build & Deploy to Cloud Run"
    runs-on: ubuntu-latest
    needs: [test-pre-build]
    if: always() && (needs.test-pre-build.result == 'success' || needs.test-pre-build.result == 'skipped')
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    
    outputs:
      service-url: ${{ steps.deploy.outputs.service-url }}
      image-digest: ${{ steps.build.outputs.image-digest }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/859242575175/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider"
          service_account: "github-actions-deploy@api-for-warp-drive.iam.gserviceaccount.com"
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
        
      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "tag=pr-${{ github.event.number }}-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Build Docker image
        id: build
        run: |
          IMAGE_URI="${{ env.REGISTRY }}/${{ env.SERVICE_NAME }}:${{ steps.image-tag.outputs.tag }}"
          echo "Building image: $IMAGE_URI"
          
          docker build \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            --build-arg GIT_BRANCH="${{ github.ref_name }}" \
            -t "$IMAGE_URI" .
            
          docker push "$IMAGE_URI"
          
          # Get image digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_URI" | cut -d'@' -f2)
          echo "image-digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          IMAGE_URI="${{ steps.build.outputs.image-uri }}"
          ENV="${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}"
          SERVICE_NAME_ENV="${{ env.SERVICE_NAME }}-$ENV"
          
          echo "Deploying $IMAGE_URI to $SERVICE_NAME_ENV in ${{ env.REGION }}"
          
          gcloud run deploy "$SERVICE_NAME_ENV" \
            --image="$IMAGE_URI" \
            --region="${{ env.REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --concurrency=100 \
            --set-env-vars="NODE_ENV=$ENV,GCP_PROJECT=${{ env.PROJECT_ID }},REGION=${{ env.REGION }}" \
            --labels="environment=$ENV,service=integration-gateway,managed-by=github-actions" \
            --tag="${{ github.sha }}" \
            --quiet
            
          # Get service URL
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME_ENV" \
            --region="${{ env.REGION }}" \
            --format="value(status.url)")
            
          echo "service-url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service deployed at: $SERVICE_URL"
          
      - name: Update deployment status
        if: always()
        run: |
          STATUS="${{ job.status }}"
          echo "Deployment $STATUS for environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}"

  # Test Phase 2 - Post-deployment Testing
  test-post-deploy:
    name: "T2: Post-deployment Tests"
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always() && needs.build-and-deploy.result == 'success' && !github.event.inputs.skip_tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Wait for service to be ready
        run: |
          SERVICE_URL="${{ needs.build-and-deploy.outputs.service-url }}"
          echo "Waiting for service at $SERVICE_URL to be ready..."
          
          for i in {1..30}; do
            if curl -s -f "$SERVICE_URL/health" > /dev/null 2>&1; then
              echo "‚úÖ Service is ready!"
              break
            elif curl -s -f "$SERVICE_URL" > /dev/null 2>&1; then
              echo "‚úÖ Service is responding!"
              break
            else
              echo "‚è≥ Attempt $i/30: Service not ready yet..."
              sleep 10
            fi
          done
          
      - name: Run health checks
        run: |
          SERVICE_URL="${{ needs.build-and-deploy.outputs.service-url }}"
          
          echo "üîç Running health checks..."
          
          # Basic connectivity test
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "‚úÖ Basic connectivity: $HTTP_CODE"
          else
            echo "‚ùå Basic connectivity failed: $HTTP_CODE"
            exit 1
          fi
          
          # Health endpoint test (if available)
          if curl -s -f "$SERVICE_URL/health" > /dev/null 2>&1; then
            echo "‚úÖ Health endpoint responding"
          else
            echo "‚ÑπÔ∏è Health endpoint not available or not responding"
          fi
          
      - name: Run integration tests
        run: |
          SERVICE_URL="${{ needs.build-and-deploy.outputs.service-url }}"
          
          echo "üß™ Running integration tests..."
          
          # Test API endpoints if they exist
          if curl -s -f "$SERVICE_URL/api" > /dev/null 2>&1; then
            echo "‚úÖ API endpoint accessible"
          fi
          
          # Test static assets
          if curl -s -f "$SERVICE_URL/js/app.js" > /dev/null 2>&1; then
            echo "‚úÖ Static assets serving"
          fi
          
          echo "‚úÖ Integration tests completed"
          
      - name: Performance baseline test
        run: |
          SERVICE_URL="${{ needs.build-and-deploy.outputs.service-url }}"
          
          echo "‚ö° Running performance baseline test..."
          
          # Simple response time test
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$SERVICE_URL")
          echo "Response time: ${RESPONSE_TIME}s"
          
          # Check if response time is reasonable (under 5 seconds)
          if (( $(echo "$RESPONSE_TIME < 5.0" | bc -l) )); then
            echo "‚úÖ Performance baseline met"
          else
            echo "‚ö†Ô∏è Performance baseline exceeded (${RESPONSE_TIME}s > 5.0s)"
          fi

  # Test Phase 3 - Final Validation
  test-final-validation:
    name: "T3: Final Validation"
    runs-on: ubuntu-latest
    needs: [build-and-deploy, test-post-deploy]
    if: always() && needs.build-and-deploy.result == 'success'
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/859242575175/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider"
          service_account: "github-actions-deploy@api-for-warp-drive.iam.gserviceaccount.com"
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Validate deployment
        run: |
          ENV="${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}"
          SERVICE_NAME_ENV="${{ env.SERVICE_NAME }}-$ENV"
          
          echo "üîç Validating deployment of $SERVICE_NAME_ENV..."
          
          # Check service status
          STATUS=$(gcloud run services describe "$SERVICE_NAME_ENV" \
            --region="${{ env.REGION }}" \
            --format="value(status.conditions[0].status)")
            
          if [ "$STATUS" = "True" ]; then
            echo "‚úÖ Service status: Healthy"
          else
            echo "‚ùå Service status: Unhealthy"
            exit 1
          fi
          
          # Check resource utilization
          echo "üìä Service metrics:"
          gcloud run services describe "$SERVICE_NAME_ENV" \
            --region="${{ env.REGION }}" \
            --format="table(metadata.name,status.url,status.observedGeneration,status.conditions[0].status)"
            
      - name: Generate deployment report
        run: |
          ENV="${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}"
          SERVICE_URL="${{ needs.build-and-deploy.outputs.service-url }}"
          IMAGE_DIGEST="${{ needs.build-and-deploy.outputs.image-digest }}"
          
          cat << EOF > deployment-report.md
          # Deployment Report
          
          ## Summary
          - **Environment**: $ENV
          - **Service URL**: $SERVICE_URL
          - **Git Commit**: ${{ github.sha }}
          - **Git Branch**: ${{ github.ref_name }}
          - **Image Digest**: $IMAGE_DIGEST
          - **Deployment Time**: $(date -u)
          - **Triggered By**: ${{ github.actor }}
          
          ## Test Results
          - **Pre-build Tests**: ${{ needs.test-pre-build.result || 'skipped' }}
          - **Post-deploy Tests**: ${{ needs.test-post-deploy.result || 'skipped' }}
          - **Final Validation**: ${{ job.status }}
          
          ## Service Information
          - **Region**: ${{ env.REGION }}
          - **Project**: ${{ env.PROJECT_ID }}
          - **Platform**: Google Cloud Run
          
          EOF
          
          echo "üìã Deployment Report Generated"
          cat deployment-report.md
          
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ needs.build-and-deploy.outputs.service-url }}';
            const environment = '${{ github.event.inputs.environment || "development" }}';
            
            const comment = `## üöÄ Deployment Preview Ready!
            
            **Environment**: ${environment}
            **Service URL**: ${deploymentUrl}
            **Commit**: ${context.sha.substring(0, 7)}
            
            ### Test Results
            - Pre-build Tests: ${{ needs.test-pre-build.result || 'skipped' }}
            - Post-deploy Tests: ${{ needs.test-post-deploy.result || 'skipped' }}
            - Final Validation: ${{ job.status }}
            
            The deployment is ready for testing! üéâ`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Cleanup job for PR deployments
  cleanup-pr-deployment:
    name: "Cleanup PR Deployment"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/859242575175/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider"
          service_account: "github-actions-deploy@api-for-warp-drive.iam.gserviceaccount.com"
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Delete PR deployment
        run: |
          SERVICE_NAME_PR="${{ env.SERVICE_NAME }}-pr-${{ github.event.number }}"
          
          if gcloud run services describe "$SERVICE_NAME_PR" --region="${{ env.REGION }}" > /dev/null 2>&1; then
            echo "üóëÔ∏è Deleting PR deployment: $SERVICE_NAME_PR"
            gcloud run services delete "$SERVICE_NAME_PR" --region="${{ env.REGION }}" --quiet
            echo "‚úÖ PR deployment cleaned up"
          else
            echo "‚ÑπÔ∏è No PR deployment found to clean up"
          fi
